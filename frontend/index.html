<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Weight Insights</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@400&display=swap"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="style.css" />
    </head>

    <body>
        <header>
            <h1>
                <span class="logo-icon" aria-hidden="true">üìä</span> Weight
                Insights
            </h1>
            <button
                id="theme-toggle"
                title="Toggle Theme"
                aria-label="Toggle Theme"
            >
                üåô
            </button>
        </header>

        <div
            id="status-message"
            class="status-message"
            role="alert"
            aria-live="polite"
        ></div>

        <main class="dashboard-container">
            <div class="left-sidebar">
                <section
                    id="all-time-stats-card"
                    class="card"
                    aria-labelledby="all-time-stats-heading"
                >
                    <h2 id="all-time-stats-heading">
                        <span class="icon" aria-hidden="true">‚öñÔ∏è</span> Weight
                        Overview <small>(All Time)</small>
                    </h2>
                    <div class="stat-item">
                        <span>Starting Weight:</span>
                        <div>
                            <span id="starting-weight" class="stat-value"
                                >N/A</span
                            >
                            KG
                        </div>
                    </div>
                    <div class="stat-item">
                        <span>Latest Weight:</span>
                        <div>
                            <span id="current-weight" class="stat-value"
                                >N/A</span
                            >
                            KG
                        </div>
                    </div>
                    <div class="stat-item">
                        <span>Latest SMA:</span>
                        <div>
                            <span id="current-sma" class="stat-value">N/A</span>
                            KG
                        </div>
                    </div>
                    <div class="stat-item">
                        <span>Total Change:</span>
                        <div>
                            <span id="total-change" class="stat-value"
                                >N/A</span
                            >
                            KG
                        </div>
                    </div>
                    <hr />
                    <div class="stat-item highlight-trigger">
                        <span>Max Weight:</span>
                        <div>
                            <span id="max-weight" class="stat-value">N/A</span>
                            KG on
                            <span
                                id="max-weight-date"
                                class="stat-date highlightable"
                                >N/A</span
                            >
                        </div>
                    </div>
                    <div class="stat-item highlight-trigger">
                        <span>Min Weight:</span>
                        <div>
                            <span id="min-weight" class="stat-value">N/A</span>
                            KG on
                            <span
                                id="min-weight-date"
                                class="stat-date highlightable"
                                >N/A</span
                            >
                        </div>
                    </div>

                    <div class="insight-group">
                        <h4>
                            Trends & Correlation
                            <span
                                class="info-icon"
                                title="Trends and correlations calculated based on the current Analysis Range. Volatility measures the standard deviation of raw weights around the SMA (excluding outliers). Smoothed Rate is the 7-day rolling average of daily SMA change. Regression Slope is calculated from the selected Regression Range (or Analysis Range if none selected). Correlation is the Pearson coefficient between weekly average net calories and weekly rate of change."
                                >‚ìò</span
                            >
                        </h4>
                        <div
                            class="stat-item"
                            title="Standard deviation of raw weight points around the smoothed average (SMA) within the analysis range, excluding outliers. Higher values mean more day-to-day fluctuation."
                        >
                            <span>Volatility:</span>
                            <div>
                                <span id="volatility-score" class="stat-value"
                                    >N/A</span
                                >
                                KG
                            </div>
                        </div>
                        <div class="stat-item">
                            <span
                                title="The 7-day smoothed rate of weight change based on the SMA trend, calculated for the end of the analysis range."
                                >Smoothed Weekly Œî Rate:</span
                            >
                            <div>
                                <span
                                    id="rolling-weekly-change-sma"
                                    class="stat-value"
                                    >N/A</span
                                >
                                KG/wk
                            </div>
                        </div>
                        <div class="stat-item">
                            <span
                                title="The weekly rate of change calculated from the linear regression line fitted to the data within the selected regression range (defaults to analysis range start)."
                                >Lin. Reg. Slope
                                <small
                                    >(from
                                    <span id="regression-start-date-label"
                                        >Range Start</span
                                    >)
                                </small>
                            </span>
                            <div>
                                <span id="regression-slope" class="stat-value"
                                    >N/A</span
                                >
                                KG/wk
                            </div>
                        </div>
                        <div
                            class="stat-item"
                            title="Pearson correlation coefficient between the average weekly net calorie balance (Intake - GFit TDEE) and the average weekly rate of weight change, for full weeks within the analysis range. Values closer to +1 or -1 indicate a stronger linear relationship. Requires at least 4 full weeks of data."
                        >
                            <span>Correlation (Net Cal vs Rate):</span>
                            <div>
                                <span
                                    id="netcal-rate-correlation"
                                    class="stat-value"
                                    >N/A</span
                                >
                                r
                            </div>
                        </div>
                    </div>
                    <hr />
                </section>

                <section
                    id="analysis-settings-card"
                    class="card"
                    aria-labelledby="analysis-settings-heading"
                >
                    <h2 id="analysis-settings-heading">
                        <span class="icon" aria-hidden="true">‚è±Ô∏è</span> Analysis
                        Range Settings
                    </h2>
                    <div id="analysis-range-controls">
                        <div class="form-row">
                            <label for="analysisStartDate">Start Date:</label>
                            <input
                                type="date"
                                id="analysisStartDate"
                                aria-label="Start date for custom analysis range"
                            />
                        </div>
                        <div class="form-row">
                            <label for="analysisEndDate">End Date:</label>
                            <input
                                type="date"
                                id="analysisEndDate"
                                aria-label="End date for custom analysis range"
                            />
                        </div>
                        <div class="button-group">
                            <button id="updateAnalysisRange">
                                Apply Range
                            </button>
                            <button
                                id="resetAnalysisRange"
                                class="button-secondary"
                            >
                                Use Chart View
                            </button>
                        </div>
                        <div class="current-range-display">
                            Currently Analyzing:
                            <strong id="analysis-range-display"
                                >Loading...</strong
                            >
                        </div>
                    </div>
                </section>

                <section
                    id="analysis-results-card"
                    class="card"
                    aria-labelledby="analysis-results-heading"
                >
                    <h2 id="analysis-results-heading">
                        <span class="icon" aria-hidden="true">üìà</span> Analysis
                        Results
                        <small>(Loading...)</small>
                    </h2>

                    <div id="insight-summary" class="insight-summary">
                        <p>Loading analysis...</p>
                    </div>
                    <hr />

                    <div class="insight-group">
                        <h4>
                            Energy Balance Estimation
                            <span
                                class="info-icon"
                                title="Average daily calorie intake, expenditure reported by Google Fit, and the resulting net balance within the analysis range. Estimated Daily Balance is calculated from the weight trend (smoothed rate or regression)."
                                >‚ìò</span
                            >
                        </h4>
                        <div class="stat-item">
                            <span>Avg Intake:</span>
                            <div>
                                <span id="avg-intake" class="stat-value"
                                    >N/A</span
                                >
                                kcal/d
                            </div>
                        </div>
                        <div class="stat-item">
                            <span>Avg Expend (GFit):</span>
                            <div>
                                <span id="avg-expenditure" class="stat-value"
                                    >N/A</span
                                >
                                kcal/d
                            </div>
                        </div>
                        <div class="stat-item">
                            <span>Avg Net (Intake - GFit):</span>
                            <div>
                                <span id="avg-net-balance" class="stat-value"
                                    >N/A</span
                                >
                                kcal/d
                            </div>
                        </div>
                        <div
                            class="stat-item"
                            title="Estimated average daily calorie surplus (+) or deficit (-) based on the calculated weekly rate of weight change (Smoothed Rate or Regression Slope). Assumes 7700 kcal per kg of weight change."
                        >
                            <span>Est. Daily Balance (from Trend):</span>
                            <div>
                                <span
                                    id="estimated-deficit-surplus"
                                    class="stat-value"
                                    >N/A</span
                                >
                                kcal/d
                            </div>
                        </div>
                    </div>
                    <hr />

                    <div class="insight-group">
                        <h4>
                            TDEE Estimation Comparison
                            <span
                                class="info-icon"
                                title="Comparison of different Total Daily Energy Expenditure (TDEE) estimates within the analysis range. GFit: Average from Google Fit. Weight Trend: Calculated from average intake and weight change rate (using 7700 kcal/kg). Adaptive: Calculated over a longer window (typically 28 days) using intake and SMA change, potentially more robust to short-term fluctuations. Difference: Smoothed average difference between Trend TDEE and GFit TDEE."
                                >‚ìò</span
                            >
                        </h4>
                        <div class="stat-item">
                            <span>Avg TDEE (GFit):</span>
                            <div>
                                <span id="avg-tdee-gfit" class="stat-value"
                                    >N/A</span
                                >
                                kcal/d
                            </div>
                        </div>
                        <div
                            class="stat-item"
                            title="TDEE estimated based on average calorie intake and the rate of weight change (smoothed or regression) within the analysis range."
                        >
                            <span>Est. TDEE (from Weight Trend):</span>
                            <div>
                                <span
                                    id="avg-tdee-wgt-change"
                                    class="stat-value"
                                    >N/A</span
                                >
                                kcal/d
                            </div>
                        </div>
                        <div
                            class="stat-item"
                            title="TDEE estimated over a longer window (28 days) using average intake and the change in the smoothed weight average (SMA). This method aims to be more stable against daily noise."
                        >
                            <span>Est. TDEE (Adaptive):</span>
                            <div>
                                <span id="avg-tdee-adaptive" class="stat-value"
                                    >N/A</span
                                >
                                kcal/d
                            </div>
                        </div>
                        <div
                            class="stat-item"
                            title="The 14-day smoothed average difference between the TDEE estimated from weight trend and the TDEE reported by Google Fit. A consistent positive or negative difference might indicate systematic over/under-reporting by GFit relative to actual expenditure reflected in weight change."
                        >
                            <span>Avg TDEE Difference (Trend - GFit):</span>
                            <div>
                                <span
                                    id="avg-tdee-difference"
                                    class="stat-value"
                                    >N/A</span
                                >
                                kcal/d
                            </div>
                        </div>
                    </div>
                    <hr />

                    <div class="insight-group">
                        <h4>
                            Logging Consistency
                            <span
                                class="info-icon"
                                title="Percentage of days within the analysis range that have logged data for Weight and Calories respectively. Higher consistency leads to more reliable analysis."
                                >‚ìò</span
                            >
                        </h4>
                        <div
                            class="stat-item"
                            title="Percentage of days within the analysis range with a logged weight entry."
                        >
                            <span>Weight Logging Consistency:</span>
                            <div>
                                <span id="weight-consistency" class="stat-value"
                                    >N/A</span
                                >%
                                <span
                                    id="weight-consistency-details"
                                    class="stat-details"
                                ></span>
                            </div>
                        </div>
                        <div
                            class="stat-item"
                            title="Percentage of days within the analysis range with a logged calorie intake entry."
                        >
                            <span>Calorie Logging Consistency:</span>
                            <div>
                                <span
                                    id="calorie-consistency"
                                    class="stat-value"
                                    >N/A</span
                                >%
                                <span
                                    id="calorie-consistency-details"
                                    class="stat-details"
                                ></span>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div
                class="chart-section card"
                aria-label="Weight and Performance Metric Charts"
            >
                <div
                    id="chart-container"
                    role="img"
                    aria-label="Main weight chart showing raw data, smoothed trend (SMA), bands, regression, expected weight, manual trends, goal line, annotations, and highlighted points. Use mouse wheel or trackpad to zoom/pan. Drag horizontally on chart to select regression range."
                ></div>

                <div
                    id="context-chart-container"
                    role="img"
                    aria-label="Chart overview and brush control for selecting the main chart view."
                ></div>

                <div
                    id="legend-container"
                    aria-label="Chart Legend (Click items to toggle visibility)"
                ></div>

                <div
                    id="balance-chart-container"
                    role="img"
                    aria-label="Daily calorie balance chart (Intake - GFit TDEE)."
                ></div>
                <div
                    id="rate-of-change-container"
                    role="img"
                    aria-label="Smoothed weekly rate of weight change chart (kg/week)."
                ></div>
                <div
                    id="tdee-reconciliation-container"
                    role="img"
                    aria-label="Smoothed difference between Trend-Estimated TDEE and Google Fit TDEE (kcal/day)."
                ></div>

                <div
                    id="correlation-scatter-container"
                    role="img"
                    aria-label="Scatter plot showing Weekly Net Calories vs. Weekly Rate of Change from the Analysis Range."
                ></div>

                <div
                    id="weekly-summary-container"
                    class="weekly-summary-section"
                >
                    <h4>Weekly Summary <small>(Analysis Range)</small></h4>
                    <p class="loading-msg">Loading weekly summary...</p>
                    <p class="empty-msg" style="display: none">
                        No weekly data available for the selected analysis
                        range.
                    </p>
                </div>
            </div>

            <div class="right-sidebar">
                <section
                    id="controls-section"
                    class="card"
                    aria-labelledby="controls-heading"
                >
                    <h2 id="controls-heading">
                        <span class="icon" aria-hidden="true">‚öôÔ∏è</span> View &
                        Interaction Controls
                    </h2>
                    <hr class="subtle-hr" />
                    <div class="control-group toggle-group">
                        <label for="toggleRegression" class="switch-label"
                            >Show Regression Line:</label
                        >
                        <label
                            class="switch"
                            aria-label="Toggle Linear Regression Line Visibility"
                        >
                            <input
                                type="checkbox"
                                id="toggleRegression"
                                checked
                            />
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="control-group toggle-group">
                        <label
                            for="dynamic-y-axis-toggle"
                            class="switch-label"
                            title="Automatically adjust Y-Axis range based only on currently visible data points. Can make small changes easier to see but cause jumps when panning/zooming."
                            >Dynamic Y-Axis:</label
                        >
                        <label
                            class="switch"
                            aria-label="Toggle Dynamic Y-Axis Calculation"
                        >
                            <input type="checkbox" id="dynamic-y-axis-toggle" />
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <hr class="subtle-hr" />
                    <div id="trendline-controls">
                        <h3>Manual Trendlines</h3>
                        <div class="trendline-input-group">
                            <label for="trendStartDate">Start Date:</label>
                            <input
                                type="date"
                                id="trendStartDate"
                                value="2025-01-01"
                                aria-label="Manual trendline start date"
                            />
                            <label for="trendInitialWeight">Start Wgt:</label>
                            <input
                                type="number"
                                id="trendInitialWeight"
                                value="69.4"
                                step="0.1"
                                placeholder="e.g., 70.0"
                                aria-label="Manual trendline initial weight in KG"
                            />
                            <label for="trendWeeklyIncrease"
                                >Rate 1
                                <span class="trend-color-1">(Green)</span
                                >:</label
                            >
                            <input
                                type="number"
                                id="trendWeeklyIncrease"
                                value="0.3"
                                step="0.01"
                                placeholder="e.g., 0.25"
                                aria-label="Manual trendline weekly weight change (Green line) in KG/wk"
                            />
                            <label for="trendWeeklyIncrease_2"
                                >Rate 2
                                <span class="trend-color-2">(Red)</span>:</label
                            >
                            <input
                                type="number"
                                id="trendWeeklyIncrease_2"
                                value="0.2"
                                step="0.01"
                                placeholder="e.g., 0.15"
                                aria-label="Manual trendline weekly weight change (Red line) in KG/wk"
                            />
                        </div>
                        <small class="control-note"
                            >Regression start date also uses 'Start Date' above.
                            (Can be overridden by interactive brush on
                            chart)</small
                        >
                    </div>
                </section>

                <section
                    id="goal-tracker-card"
                    class="card"
                    aria-labelledby="goal-heading"
                >
                    <h2 id="goal-heading">
                        <span class="icon" aria-hidden="true">üéØ</span> Goal
                        Tracker
                    </h2>
                    <form id="goal-setting-form">
                        <div class="form-row">
                            <label for="goalWeight">Target Wgt (KG):</label>
                            <input
                                type="number"
                                id="goalWeight"
                                step="0.1"
                                placeholder="e.g., 75.0"
                                aria-label="Target weight goal in KG"
                            />
                        </div>
                        <div class="form-row">
                            <label for="goalDate">Target Date:</label>
                            <input
                                type="date"
                                id="goalDate"
                                aria-label="Target date for weight goal (optional)"
                            />
                        </div>
                        <div class="form-row">
                            <label
                                for="goalTargetRate"
                                title="Your desired average weekly weight change (e.g., 0.25 for lean gain)."
                                >Target Weekly Rate:</label
                            >
                            <input
                                type="number"
                                id="goalTargetRate"
                                step="0.05"
                                placeholder="e.g., 0.25"
                                aria-label="Target weekly weight change rate in KG (optional)"
                            />
                        </div>
                        <button type="submit">Save Goal</button>
                    </form>
                    <hr class="subtle-hr" />
                    <div id="what-if-controls">
                        <h3>"What-If" Projection</h3>
                        <div class="form-row">
                            <label for="what-if-intake"
                                >Future Daily Intake (kcal):</label
                            >
                            <input
                                type="number"
                                id="what-if-intake"
                                placeholder="e.g., 3000"
                                step="50"
                                aria-label="Hypothetical future daily calorie intake"
                            />
                        </div>
                        <div class="form-row">
                            <label for="what-if-duration"
                                >Duration (days):</label
                            >
                            <input
                                type="number"
                                id="what-if-duration"
                                value="30"
                                min="1"
                                step="1"
                                aria-label="Duration in days for projection"
                            />
                        </div>
                        <button id="what-if-submit" class="button-secondary">
                            Project Weight
                        </button>
                        <div id="what-if-result" class="what-if-result">
                            Enter intake to see projection...
                        </div>
                    </div>
                    <div class="goal-stats">
                        <div class="stat-item">
                            <span>Target Weight:</span>
                            <div>
                                <span id="target-weight-stat" class="stat-value"
                                    >N/A</span
                                >
                                KG
                            </div>
                        </div>
                        <div class="stat-item">
                            <span>Target Rate:</span>
                            <div>
                                <span id="target-rate-stat" class="stat-value"
                                    >N/A</span
                                >
                                KG/wk
                            </div>
                        </div>
                        <div class="stat-item">
                            <span
                                title="Difference between your Target Weight and your Latest SMA (Smoothed Weight Average)."
                                >Weight to Goal:</span
                            >
                            <div>
                                <span id="weight-to-goal" class="stat-value"
                                    >N/A</span
                                >
                                KG
                            </div>
                        </div>
                        <div class="stat-item">
                            <span
                                title="Compares your current trend (Smoothed Rate or Regression Slope) to your Target Rate."
                                >Actual Rate vs Target:</span
                            >
                            <span
                                id="current-rate-feedback"
                                class="stat-value feedback"
                                >N/A</span
                            >
                        </div>
                        <hr class="subtle-hr" />
                        <div
                            class="stat-item"
                            title="Estimated time to reach your Target Weight based on your current trend (Smoothed Rate or Regression Slope)."
                        >
                            <span>Est. Time to Target Wgt:</span>
                            <span id="estimated-time-to-goal" class="stat-value"
                                >N/A</span
                            >
                        </div>
                        <div
                            class="stat-item"
                            title="The average weekly weight change required to reach your Target Weight by your Target Date, starting from your Latest SMA."
                        >
                            <span>Required Rate for Target Date:</span>
                            <div>
                                <span
                                    id="required-rate-for-goal"
                                    class="stat-value"
                                    >N/A</span
                                >
                                KG/wk
                            </div>
                        </div>
                        <div
                            class="stat-item"
                            title="The estimated average daily net calorie balance (surplus or deficit) needed to achieve the Required Rate for Target Date."
                        >
                            <span>Required Net Calories for Date:</span>
                            <div>
                                <span
                                    id="required-net-calories"
                                    class="stat-value"
                                    >N/A</span
                                >
                                kcal/d
                            </div>
                        </div>
                        <div
                            class="stat-item"
                            title="A suggested daily calorie intake range (based on your estimated TDEE and the Required Net Calories) to help you reach your goal by the Target Date."
                        >
                            <span>Suggested Intake for Date:</span>
                            <div>
                                <span
                                    id="suggested-intake-range"
                                    class="stat-value"
                                    >N/A</span
                                >
                                kcal/d
                            </div>
                        </div>
                    </div>
                </section>

                <section
                    id="annotations-section"
                    class="card"
                    aria-labelledby="annotations-heading"
                >
                    <h2 id="annotations-heading">
                        <span class="icon" aria-hidden="true">üìå</span>
                        Annotations
                    </h2>
                    <form id="annotation-form">
                        <div class="form-row">
                            <label for="annotation-date">Date:</label>
                            <input
                                type="date"
                                id="annotation-date"
                                required
                                aria-label="Date for annotation"
                            />
                        </div>
                        <div class="form-row">
                            <label for="annotation-text">Note:</label>
                            <input
                                type="text"
                                id="annotation-text"
                                placeholder="e.g., Vacation Start"
                                required
                                aria-label="Annotation text"
                            />
                        </div>
                        <button type="submit">Add Annotation</button>
                    </form>
                    <hr class="subtle-hr" />
                    <h3>Saved Annotations</h3>
                    <ul id="annotation-list" class="annotation-list">
                        <li>Loading annotations...</li>
                    </ul>
                </section>
            </div>
        </main>

        <div id="pinned-tooltip-container"></div>
        <div
            id="tooltip"
            class="tooltip"
            role="tooltip"
            style="opacity: 0"
        ></div>

        <script src="https://d3js.org/d3.v7.min.js"></script>
        <script src="https://unpkg.com/simple-statistics@7.8.3/dist/simple-statistics.min.js"></script>
        <script src="chart.js"></script>
    </body>
</html>
