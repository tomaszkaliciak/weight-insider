<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weight Insider | Bento</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@400&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <header>
        <h1>
            <span class="icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="feather feather-activity">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                </svg>
            </span>
            Weight Insights <span style="opacity:0.5; font-weight:300;">| Pro</span>
        </h1>
        <button id="theme-toggle" title="Toggle Theme" aria-label="Toggle Theme">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="feather feather-moon">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
        </button>
    </header>

    <div id="status-message" class="status-message" role="alert" aria-live="polite"></div>

    <main class="dashboard-container bento-mode">
        <!-- Slim Nav Rail -->
        <div class="left-sidebar bento-rail">
            <nav class="sidebar-tabs" role="tablist" aria-label="Sidebar sections">
                <!-- SCROLL ANCHORS: data-target points to widget ID -->
                <button class="tab-btn active" data-target="hero-weight-widget" role="tab" aria-selected="true"
                    title="Overview">
                    <span class="tab-icon">üìä</span>
                </button>
                <button class="tab-btn" data-target="goal-widget" role="tab" aria-selected="false" title="Goals">
                    <span class="tab-icon">üéØ</span>
                </button>
                <button class="tab-btn" data-target="chart-section" role="tab" aria-selected="false" title="Analytics">
                    <span class="tab-icon">üìà</span>
                </button>
                <button class="tab-btn" data-target="analysis-settings-widget" role="tab" aria-selected="false"
                    title="Settings">
                    <span class="tab-icon">‚öôÔ∏è</span>
                </button>
            </nav>
        </div>

        <!-- Main Bento Canvas -->
        <div class="bento-canvas">

            <!-- ROW 1: High-Level KPIs & Summary -->
            <!-- Widget 1: Hero Weight (1x1) -->
            <div id="hero-weight-widget" class="bento-widget span-1x1">
                <div class="text-subhero">Current Weight</div>
                <div style="margin-top: auto; margin-bottom: auto;">
                    <span id="current-weight" class="text-hero">--</span>
                    <span style="font-size: 1.2rem; font-weight: 500; color: var(--text-muted);">kg</span>
                </div>
                <div id="trend-flux-container" class="trend-flux-container" style="display:none; margin-top: 8px;">
                </div>
            </div>

            <!-- Widget 2: Executive Summary (2x1) -->
            <div id="executive-hub-card" class="bento-widget span-2x1">
                <div class="widget-header">Executive Summary</div>
                <div id="executive-hub-content"></div>
            </div>

            <!-- ROW 2 & 3: Deep Analysis (Chart + Side Stack) -->
            <!-- Widget 3: Master Chart (2x2) -->
            <div id="chart-section" class="bento-widget span-2x2 chart-section" aria-labelledby="chart-section-heading">
                <div class="widget-header">
                    <span id="chart-section-heading">Master Trend Analysis</span>
                    <div class="chart-controls">
                        <button id="chart-fullscreen-btn" class="icon-btn" title="Toggle Fullscreen"
                            aria-label="Toggle Fullscreen">
                            ‚õ∂
                        </button>
                    </div>
                </div>
                <div style="flex: 1; min-height: 0; position: relative; width:100%; height:100%;">
                    <div id="chart-container" style="width:100%; height:100%;"></div>
                    <div id="context-chart-container"
                        style="position:absolute; bottom:0; left:0; width:100%; height:70px; opacity:0; pointer-events:none;">
                    </div>
                    <canvas id="weight-chart" style="display:none;"></canvas>
                </div>
                <div id="loading-spinner" class="spinner" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
            </div>

            <!-- Right Column Stack -->
            <!-- Widget 4: Vital Stats (1x1) -->
            <div id="key-stats-widget" class="bento-widget span-1x1">
                <div class="widget-header">Vital Stats</div>
                <div class="stat-grid">
                    <div class="stat-group">
                        <div class="stat-label">SMA</div>
                        <span id="current-sma" class="stat-value">--</span>
                    </div>
                    <div class="stat-group">
                        <div class="stat-label">Change</div>
                        <span id="total-change" class="stat-value">--</span>
                    </div>
                    <div class="stat-group">
                        <div class="stat-label">TDEE</div>
                        <span id="current-tdee" class="stat-value">--</span>
                    </div>
                    <div class="stat-group">
                        <div class="stat-label">Rate</div>
                        <span id="rolling-weekly-change-sma" class="stat-value">--</span>
                    </div>
                </div>
            </div>

            <!-- Widget 5: Goal Progress (1x1) -->
            <div id="goal-widget" class="bento-widget span-1x1">
                <div class="widget-header">Goal Progress</div>
                <div id="smart-coach-container"></div>
            </div>

            <!-- ROW 4: Controls -->
            <!-- Widget 6: Analysis Settings (3x1) -->
            <div id="analysis-settings-widget" class="bento-widget span-3x1">
                <div class="widget-header">Analysis Range</div>
                <div id="analysis-settings-content" class="analysis-range-form">
                    <div class="range-controls-inline">
                        <label><span>Start:</span><input type="date" id="analysisStartDate"
                                name="analysisStartDate"></label>
                        <label><span>End:</span><input type="date" id="analysisEndDate" name="analysisEndDate"></label>
                        <button type="button" id="updateAnalysisRange" class="btn-primary">Apply</button>
                    </div>
                    <div class="range-presets">
                        <button type="button" class="preset-btn" data-range="7">7D</button>
                        <button type="button" class="preset-btn" data-range="30">30D</button>
                        <button type="button" class="preset-btn" data-range="90">90D</button>
                        <button type="button" class="preset-btn" data-range="all">All</button>
                    </div>
                </div>
            </div>

            <!-- ROW 5: Advanced Metrics -->
            <!-- Rate of Change (2x1) -->
            <div id="rate-change-card" class="bento-widget span-2x1">
                <div class="widget-header">Rate of Change</div>
                <div id="rate-of-change-container" style="width:100%; height:100%;"></div>
            </div>

            <!-- TDEE Accuracy (1x1) -->
            <div id="tdee-accuracy-card" class="bento-widget span-1x1">
                <div class="widget-header">TDEE Accuracy</div>
                <div id="tdee-accuracy-content">
                    <div id="tdee-accuracy-container"></div>
                </div>
            </div>

            <!-- ROW 6: Energy Dynamics -->
            <!-- Energy Balance History (2x1) -->
            <div id="energy-balance-card" class="bento-widget span-2x1">
                <div class="widget-header">Energy Balance History</div>
                <div id="balance-chart-container" style="width:100%; height:100%;"></div>
            </div>

            <!-- Energy Sankey (1x1) -->
            <div id="energy-sankey-card" class="bento-widget span-1x1">
                <div class="widget-header">Energy Flow</div>
                <div id="energy-sankey-content">
                    <div class="energy-sankey-container" id="energy-sankey-diagram">
                        <div id="energy-sankey-chart"></div>
                    </div>
                </div>
            </div>

            <!-- ROW 7: Secondary Metrics -->
            <!-- Weekly Review (2x1) -->
            <div id="weekly-review-card" class="bento-widget span-2x1">
                <div class="widget-header">Weekly Review</div>
                <div id="weekly-review-content"></div>
            </div>

            <!-- Heatmap (1x1) -->
            <div id="calorie-heatmap-card" class="bento-widget span-1x1">
                <div class="widget-header">Heatmap</div>
                <div id="calorie-heatmap-content">
                    <div id="calorie-heatmap-container"></div>
                </div>
            </div>

            <!-- ROW 8: Correlations & Tools -->
            <!-- Correlation Matrix (2x1) -->
            <div id="correlation-matrix-card" class="bento-widget span-2x1">
                <div class="widget-header">Correlations</div>
                <div id="correlation-matrix-content">
                    <div id="correlation-matrix-container"></div>
                </div>
            </div>

            <!-- Manual Trendlines (1x1) -->
            <div id="manual-trendlines-card" class="bento-widget span-1x1">
                <div class="widget-header">Trendlines</div>
                <div id="manual-trendlines-container" class="trendlines-form">
                    <div class="form-row">
                        <label>Start<input type="date" id="trendStartDate"></label>
                        <label>Initial<input type="number" id="trendInitialWeight" step="0.1" placeholder="kg"></label>
                    </div>
                    <div class="form-row">
                        <label>Rate 1<input type="number" id="trendWeeklyIncrease" step="0.05"
                                placeholder="kg/wk"></label>
                        <label>Rate 2<input type="number" id="trendWeeklyIncrease_2" step="0.05"
                                placeholder="kg/wk"></label>
                    </div>
                    <button type="button" id="view-data-btn" class="btn-secondary">View Data Table</button>
                </div>
            </div>

            <!-- ROW 9: TDEE Reconciliation & Scatter -->
            <!-- TDEE Reconciliation (2x1) - Widened as requested, fills row nicely with Scatter -->
            <!-- wait, row is 3 cols. 2x1 TDEE + 1x1 Scatter = 3 cols. Perfect. -->

            <div id="tdee-reconcile-card" class="bento-widget span-2x1">
                <div class="widget-header">TDEE vs Intake</div>
                <div id="tdee-reconciliation-container" style="width:100%; height:100%;"></div>
            </div>

            <!-- Correlation Scatter (1x1) -->
            <div id="scatter-card" class="bento-widget span-1x1">
                <div class="widget-header">Scatter Plot</div>
                <div id="correlation-scatter-container" style="width:100%; height:100%;"></div>
            </div>

        </div>

        <!-- Hidden legacy sections to prevent JS errors if they are selected by ID but not visible -->
        <div style="display:none;">
            <!-- Legacy Chart Containers (MOVED TO WIDGETS ABOVE) -->
            <div id="weekly-summary-container"></div>
            <div id="heatmap-container"></div>
            <div id="legend-container"></div>

            <!-- Stat Holders (uiCache maps these IDs to statElements) -->
            <div id="all-time-stats-content">
                <span id="starting-weight"></span>
                <span id="min-weight"></span>
                <span id="max-weight"></span>
                <span id="starting-lbm"></span>
                <span id="current-lbm-sma"></span>
                <span id="total-lbm-change"></span>
                <span id="current-fm-sma"></span>
                <span id="total-fm-change"></span>
                <span id="volatility-score"></span>
                <span id="rolling-volatility"></span>
                <span id="rate-consistency-stddev"></span>
                <span id="regression-slope"></span>
                <span id="netcal-rate-correlation"></span>
                <span id="target-weight-stat"></span>
                <span id="target-rate-stat"></span>
                <span id="weight-to-goal"></span>
                <span id="estimated-time-to-goal"></span>
                <span id="required-rate-for-goal"></span>
                <span id="required-net-calories"></span>
                <span id="required-calorie-adjustment"></span>
                <span id="suggested-intake-range"></span>
                <span id="current-rate-feedback"></span>

                <!-- Quick stats (used by QuickStatsRenderer) -->
                <span id="qs-current-weight"></span>
                <span id="qs-weekly-change"></span>
                <span id="qs-days-tracked"></span>
                <span id="qs-to-goal"></span>
            </div>

            <!-- Containers for features not yet placed in Bento (hidden for now) -->
            <div id="periodization-content"></div>
            <div id="period-comparison-content"></div>
            <div id="goal-alerts-content"></div>
            <div id="goal-suggestions-content">
                <div id="goal-suggestions-list"></div>
            </div>
            <div id="event-countdown-content"></div>
            <div id="weekend-analysis-content"></div>
            <div id="prediction-bands-content"></div>
            <div id="adaptive-rate-content"></div>
            <div id="calorie-audit-content"></div>
            <div id="monthly-report-content"></div>
            <div id="what-worked-content"></div>
            <div id="plateau-breaker-content"></div>
            <div id="rolling-averages-content"></div>
            <div id="streak-tracker-content"></div>
            <div id="water-weight-content"></div>
            <div id="reverse-diet-content"></div>
            <div id="rate-optimizer-content"></div>
            <div id="metabolic-adaptation-content">
                <div id="tdee-trend-chart"></div>
            </div>
            <div id="goal-simulator-content">
                <div id="goal-sim-chart"></div>
            </div>
            <div id="macro-impact-content"></div>

            <!-- Legacy Energy Balance -->
            <div id="energy-chart-container"></div>
            <div id="energy-balance-content">
                <div id="energy-balance-chart"></div>
            </div>

            <!-- Trendline inputs now in visible widget -->
            <button id="updateAnalysisRangeBtn" style="display:none"></button>

            <!-- Goal Form Inputs -->
            <input id="goalWeight" type="hidden">
            <input id="goalDate" type="hidden">
            <input id="goalTargetRate" type="hidden">

            <!-- Annotations -->
            <form id="annotation-form">
                <input id="annotation-date" type="hidden">
                <input id="annotation-text" type="hidden">
            </form>
            <ul id="annotation-list"></ul>

            <!-- What-If -->
            <input id="what-if-intake" type="hidden">
            <input id="what-if-duration" type="hidden">
            <button id="what-if-submit" style="display:none"></button>
            <div id="what-if-result"></div>
        </div>
    </main>

    <!-- Essential Absolute Elements -->
    <div id="tooltip" class="tooltip" style="opacity: 0;"></div>
    <div id="pinned-tooltip-container"></div>
    <div id="chart-tooltip" class="context-menu" style="display: none;"></div>

    <!-- Modal for Data Table -->
    <div id="data-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="modal-title">
        <div class="modal-content card">
            <div class="modal-header">
                <h2 id="modal-title">Weight & Calorie Data</h2>
                <button class="close-modal" aria-label="Close Modal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="table-container">
                    <table id="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Weight (kg)</th>
                                <th>Trend (kg)</th>
                                <th>Calories</th>
                                <th>TDEE (kcal)</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div id="modal-overlay" class="modal-overlay" aria-hidden="true"></div>

    <script type="module" src="js/main.js"></script>
</body>

</html>